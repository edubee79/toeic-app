<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 및 성과 관리 | 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; }
        .tab-btn.active { background-color: #0f172a; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-pass { background-color: #dcfce7; color: #166534; }
        .status-fail { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="min-h-screen">

    <div id="admin-root" class="flex w-full min-h-screen">
        <aside class="w-64 bg-slate-900 text-white flex flex-col shrink-0 h-screen sticky top-0">
            <div class="p-8 text-2xl font-black italic tracking-tighter cursor-pointer" onclick="location.href='admin-main.html'">ADMIN ROOM</div>
            <nav class="flex-grow px-4 space-y-2">
                <a href="admin-main.html" class="flex items-center gap-3 p-4 rounded-xl text-sm font-bold text-slate-400 hover:bg-slate-800 transition-all"><i class="fas fa-chart-line"></i> 대시보드 요약</a>
                <a href="admin-lecture.html" class="flex items-center gap-3 p-4 rounded-xl text-sm font-bold text-slate-400 hover:bg-slate-800 transition-all"><i class="fas fa-book"></i> 강의/과제 관리</a>
                <a href="admin-student.html" class="bg-indigo-600 flex items-center gap-3 p-4 rounded-xl text-sm font-bold text-white shadow-lg"><i class="fas fa-user-graduate"></i> 학교/학생 관리</a>
            </nav>
        </aside>

        <main class="flex-grow p-10 overflow-y-auto">
            <header class="mb-10 flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-black text-slate-900 uppercase">Student Management</h1>
                    <p class="text-slate-500 font-medium">학생들의 이수율을 관리하고 학교/과목 리스트를 설정합니다.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="downloadExcel()" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black text-sm shadow-lg hover:bg-emerald-700 transition-all">
                        <i class="fas fa-file-excel mr-2"></i> 학생 명단 추출
                    </button>
                    <div class="bg-white px-6 py-4 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <span class="text-xs font-black text-slate-400 uppercase">Pass 기준</span>
                        <div class="flex items-center gap-2">
                            <input type="number" id="pass-threshold" value="80" oninput="loadStudents()" class="w-12 bg-slate-50 border-none rounded-lg p-2 text-center font-bold text-indigo-600">
                            <span class="font-bold text-slate-700">%</span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="flex gap-2 mb-8 bg-white p-2 rounded-2xl shadow-sm w-fit border border-slate-100">
                <button onclick="switchTab('status')" id="btn-status" class="tab-btn active px-6 py-3 rounded-xl text-sm font-black transition-all">학생 성취도</button>
                <button onclick="switchTab('manage')" id="btn-manage" class="tab-btn px-6 py-3 rounded-xl text-sm font-black text-slate-400 transition-all">조직/분류 관리</button>
            </div>

            <div id="tab-status" class="tab-content active">
                <div class="flex gap-4 mb-6">
                    <select id="filter-school" onchange="loadStudents()" class="bg-white border-none rounded-2xl px-6 py-3 text-sm font-bold shadow-sm outline-none">
                        <option value="all">전체 학교</option>
                    </select>
                    <select id="filter-class" onchange="loadStudents()" class="bg-white border-none rounded-2xl px-6 py-3 text-sm font-bold shadow-sm outline-none">
                        <option value="all">전체 수강반</option>
                    </select>
                </div>
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50/50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <tr>
                                <th class="p-8">학생정보(ID)</th>
                                <th class="p-8">소속 학교</th>
                                <th class="p-8">수강반</th>
                                <th class="p-8">이수율</th>
                                <th class="p-8">판정</th>
                                <th class="p-8 text-right">삭제</th>
                            </tr>
                        </thead>
                        <tbody id="student-list-container" class="font-bold text-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-manage" class="tab-content">
                <div class="grid lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100">
                        <h3 class="text-xl font-black text-slate-800 mb-6 italic"><i class="fas fa-university mr-2"></i> 학교 생성</h3>
                        <div class="flex gap-2 mb-8">
                            <input type="text" id="new-school" placeholder="학교명 입력" class="flex-grow bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold outline-none">
                            <button onclick="addItem('Schools', 'new-school')" class="bg-slate-900 text-white px-8 rounded-2xl font-bold text-sm">추가</button>
                        </div>
                        <div id="managed-school-list" class="space-y-3"></div>
                    </div>
                    <div class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100">
                        <h3 class="text-xl font-black text-indigo-600 mb-6 italic"><i class="fas fa-tags mr-2"></i> 수업 분류 생성</h3>
                        <div class="flex gap-2 mb-8">
                            <input type="text" id="new-category" placeholder="과목명 입력" class="flex-grow bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold outline-none">
                            <button onclick="addItem('SubjectCategories', 'new-category')" class="bg-indigo-600 text-white px-8 rounded-2xl font-bold text-sm">추가</button>
                        </div>
                        <div id="managed-category-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // [보안] 관리자 전용 접근 보안 코드 삽입
        (function() {
            const userLogined = localStorage.getItem('userLogined');
            if (!userLogined) {
                alert("로그인이 필요합니다.");
                location.replace('login.html');
                return;
            }
            const userData = JSON.parse(userLogined);
            if (userData.userId !== 'eduthot') {
                alert("관리자 권한이 없습니다.");
                location.replace('index.html');
                return;
            }
        })();

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBThrCtBNJuVcfPD3Vm6XvPD7McT5JJsN8",
            authDomain: "eduthot-fb088.firebaseapp.com",
            projectId: "eduthot-fb088",
            storageBucket: "eduthot-fb088.firebasestorage.app",
            messagingSenderId: "919552710378",
            appId: "1:919552710378:web:7ba72ea2d195e092f8a993"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.loadStudents = () => {
            onSnapshot(query(collection(db, "Users"), orderBy("createdAt", "desc")), (snap) => {
                const container = document.getElementById('student-list-container');
                const fSch = document.getElementById('filter-school').value;
                const fCls = document.getElementById('filter-class').value;
                const threshold = parseInt(document.getElementById('pass-threshold').value) || 80;
                const classSet = new Set();
                
                container.innerHTML = "";
                snap.forEach(d => {
                    const u = d.data();
                    if(u.userId === 'eduthot') return; 
                    
                    if(u.userClass) classSet.add(u.userClass);

                    if(fSch !== 'all' && u.school !== fSch) return;
                    if(fCls !== 'all' && u.userClass !== fCls) return;

                    const prog = u.progress || 0;
                    const isPass = prog >= threshold;

                    container.innerHTML += `
                        <tr class="border-b border-slate-50 hover:bg-slate-50/50">
                            <td class="p-8">${u.userName || '미입력'} <span class="text-[10px] text-slate-400">(${u.userId})</span></td>
                            <td class="p-8 text-xs text-slate-500">${u.school || '-'}</td>
                            <td class="p-8 text-xs text-indigo-600">${u.userClass || '-'}</td>
                            <td class="p-8">
                                <div class="flex items-center gap-2">
                                    <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-indigo-500" style="width:${prog}%"></div>
                                    </div>
                                    <span class="text-[11px]">${prog}%</span>
                                </div>
                            </td>
                            <td class="p-8"><span class="px-3 py-1 rounded-full text-[10px] ${isPass ? 'status-pass' : 'status-fail'}">${isPass ? 'PASS' : 'FAIL'}</span></td>
                            <td class="p-8 text-right text-slate-200 hover:text-rose-500 cursor-pointer" onclick="deleteItem('Users','${d.id}')"><i class="fas fa-trash-alt"></i></td>
                        </tr>`;
                });
                
                const clsSelect = document.getElementById('filter-class');
                const current = clsSelect.value;
                clsSelect.innerHTML = '<option value="all">전체 수강반</option>';
                Array.from(classSet).sort().forEach(c => {
                    clsSelect.innerHTML += `<option value="${c}">${c}</option>`;
                });
                clsSelect.value = current;
            });
        };

        window.addItem = async (col, inputId) => {
            const val = document.getElementById(inputId).value.trim();
            if(!val) return;
            await addDoc(collection(db, col), { name: val, createdAt: new Date() });
            document.getElementById(inputId).value = "";
        };

        window.deleteItem = async (col, id) => { if(confirm("삭제하시겠습니까?")) await deleteDoc(doc(db, col, id)); };

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.classList.add('text-slate-400'); });
            document.getElementById('tab-' + id).classList.add('active');
            event.currentTarget.classList.add('active'); event.currentTarget.classList.remove('text-slate-400');
        };

        const syncSettings = () => {
            onSnapshot(query(collection(db, "Schools"), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('managed-school-list');
                const filter = document.getElementById('filter-school');
                list.innerHTML = ""; filter.innerHTML = '<option value="all">전체 학교</option>';
                snap.forEach(d => {
                    const n = d.data().name;
                    list.innerHTML += `<div class="flex justify-between p-4 bg-slate-50 rounded-2xl text-sm font-bold"><span>${n}</span><button onclick="deleteItem('Schools','${d.id}')" class="text-slate-300 hover:text-rose-500"><i class="fas fa-trash-alt"></i></button></div>`;
                    filter.innerHTML += `<option value="${n}">${n}</option>`;
                });
            });
            onSnapshot(query(collection(db, "SubjectCategories"), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('managed-category-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    list.innerHTML += `<div class="flex justify-between p-4 bg-indigo-50/50 text-indigo-700 rounded-2xl text-sm font-bold"><span>${d.data().name}</span><button onclick="deleteItem('SubjectCategories','${d.id}')" class="text-indigo-200 hover:text-rose-500"><i class="fas fa-trash-alt"></i></button></div>`;
                });
            });
        };

        window.onload = () => { syncSettings(); loadStudents(); };
    </script>
</body>
</html>