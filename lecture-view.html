<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture View | Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://player.vimeo.com/api/player.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background: #0a0f1e; color: white; margin: 0; padding: 0; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: #000; border-radius: 1.5rem; overflow: hidden; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body class="min-h-screen">

    <nav class="w-full bg-slate-900 border-b border-white/10 p-4 flex justify-between items-center sticky top-0 z-50">
        <button onclick="location.href='my-room.html'" class="text-sm font-bold text-slate-400 hover:text-white">
            <i class="fas fa-chevron-left mr-2"></i> 강의실
        </button>
        <div id="watch-status" class="bg-indigo-600 px-4 py-2 rounded-lg text-xs font-black shadow-lg">
            시스템 초기화 중...
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-6">
        <div id="player-wrapper" class="video-wrapper shadow-2xl border border-white/5">
            <div class="absolute inset-0 flex items-center justify-center text-slate-500">영상을 불러오고 있습니다...</div>
        </div>

        <div class="mt-8 bg-slate-900/50 p-8 rounded-[2rem] border border-white/5">
            <h1 id="lesson-title" class="text-2xl font-black mb-4">강의 제목을 불러오는 중...</h1>
            <div class="w-full h-1.5 bg-white/10 rounded-full overflow-hidden">
                <div id="progress-bar-inner" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-2">
                <span id="progress-percent" class="text-[10px] font-bold text-indigo-400">0% 시청 중</span>
                <span class="text-[10px] text-slate-500 italic">90% 시청 시 자동 출석</span>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBThrCtBNJuVcfPD3Vm6XvPD7McT5JJsN8",
            authDomain: "eduthot-fb088.firebaseapp.com",
            projectId: "eduthot-fb088",
            storageBucket: "eduthot-fb088.firebasestorage.app",
            messagingSenderId: "919552710378",
            appId: "1:919552710378:web:7ba72ea2d195e092f8a993"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        const lessonId = params.get('id');
        const statusBadge = document.getElementById('watch-status');
        let isCompleted = false;

        async function startApp() {
            try {
                // 1. 로그인 체크
                const userSession = localStorage.getItem('userLogined');
                if (!userSession) { alert("로그인이 필요합니다."); location.href="login.html"; return; }
                const userData = JSON.parse(userSession);
                const userRef = doc(db, "Users", userData.userId);

                statusBadge.textContent = "데이터 조회 중...";

                // 2. 강의/유저 데이터 동시 로드
                const [lSnap, uSnap] = await Promise.all([
                    getDoc(doc(db, "Lessons", lessonId)),
                    getDoc(userRef)
                ]);

                if (!lSnap.exists()) { statusBadge.textContent = "강의를 찾을 수 없음"; return; }

                const lesson = lSnap.data();
                document.getElementById('lesson-title').textContent = lesson.title;
                const vId = String(lesson.vimeoId || lesson.vimeoid).replace(/[^0-9]/g, "");

                // 3. 플레이어 생성 (매개변수 최소화)
                const wrapper = document.getElementById('player-wrapper');
                wrapper.innerHTML = `<iframe id="v-player" src="https://player.vimeo.com/video/${vId}?autoplay=1&muted=1" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;

                const player = new Vimeo.Player(document.querySelector('#v-player'));
                
                // 4. 이어보기 데이터 확인
                const savedTime = uSnap.data()?.resumePoints?.[lessonId] || 0;

                // 5. 핵심: 재생 시작될 때 시간 맞추기
                player.on('play', async () => {
                    statusBadge.textContent = "학습 분석 중";
                    statusBadge.className = "bg-indigo-600 px-4 py-2 rounded-lg text-xs font-black shadow-lg";
                    
                    if (savedTime > 2) {
                        await player.setCurrentTime(savedTime);
                        player.setMuted(false); // 소리 켜기
                        console.log("이어보기 시점:", savedTime);
                    }
                });

                // 6. 실시간 업데이트 및 저장
                player.on('timeupdate', async (data) => {
                    const duration = await player.getDuration();
                    const percent = (data.seconds / duration) * 100;
                    
                    document.getElementById('progress-bar-inner').style.width = percent + "%";
                    document.getElementById('progress-percent').textContent = Math.round(percent) + "% 시청 중";

                    // 10초 단위 자동 저장
                    if (Math.floor(data.seconds) % 10 === 0 && Math.floor(data.seconds) > 0) {
                        updateDoc(userRef, {
                            [`resumePoints.${lessonId}`]: Math.floor(data.seconds)
                        });
                    }

                    // 90% 달성 시 완료
                    if (percent >= 90 && !isCompleted) {
                        isCompleted = true;
                        await updateDoc(userRef, {
                            watchedLessons: arrayUnion(lessonId),
                            [`resumePoints.${lessonId}`]: 0
                        });
                        statusBadge.textContent = "출석 완료";
                        statusBadge.className = "bg-emerald-500 px-4 py-2 rounded-lg text-xs font-black shadow-lg";
                    }
                });

            } catch (error) {
                console.error(error);
                statusBadge.textContent = "시스템 오류 발생";
            }
        }

        startApp();
    </script>
</body>
</html>